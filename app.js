"use strict";

var Signals = {
	Lisa:
	{
		SignalHandle: null,
		Frames:
		{
			Phone: [
				[1,0,1,1,0,1,1,0,1,0,0,0,1,0,0,1],
				[1,0,1,1,0,1,0,0,0,0,0,0,0,0,0,1],
				[0,1,1,1,0,0,1,0,0,0,0,0,0,0,0,1],
				[0,1,1,1,0,0,0,0,1,0,0,0,1,0,0,1],
				[0,0,1,0,1,1,1,0,0,0,0,0,0,0,0,1],
				[0,0,1,0,1,1,0,0,1,0,0,0,1,0,0,1],
				[1,1,1,0,1,0,1,0,1,0,0,0,1,0,0,1],
				[1,1,1,0,1,0,0,0,0,0,0,0,0,0,0,1],
				[1,1,0,1,1,1,1,0,0,0,0,0,0,0,0,1],
				[1,1,0,1,1,1,0,0,1,0,0,0,1,0,0,1]
			],
			Bell1: [
				[1,0,1,1,1,1,1,0,0,0,0,0,1,0,1,0],
				[1,0,1,1,1,1,0,0,1,0,0,0,0,0,1,0],
				[0,1,1,1,1,0,1,0,1,0,0,0,0,0,1,0],
				[0,1,1,1,1,0,0,0,0,0,0,0,1,0,1,0],
				[0,0,1,0,0,1,1,0,1,0,0,0,0,0,1,0],
				[0,0,1,0,0,1,0,0,0,0,0,0,1,0,1,0],
				[1,1,1,0,0,0,1,0,0,0,0,0,1,0,1,0],
				[1,1,1,0,0,0,0,0,1,0,0,0,0,0,1,0],
				[1,1,0,1,0,1,1,0,1,0,0,0,0,0,1,0],
				[1,1,0,1,0,1,0,0,0,0,0,0,1,0,1,0]
			],
			Button: [
				[1,1,1,1,0,1,1,0,0,0,0,0,1,1,0,0],	// All verified
				[1,1,1,1,0,1,0,0,1,0,0,0,0,1,0,0],
				[0,0,1,1,0,0,1,0,1,0,0,0,0,1,0,0],
				[0,0,1,1,0,0,0,0,0,0,0,0,1,1,0,0],
				[0,1,1,0,1,1,1,0,1,0,0,0,0,1,0,0],
				[0,1,1,0,1,1,0,0,0,0,0,0,1,1,0,0],
				[1,0,1,0,1,0,1,0,0,0,0,0,1,1,0,0],
				[1,0,1,0,1,0,0,0,1,0,0,0,0,1,0,0],
				[1,0,0,1,1,1,1,0,1,0,0,0,0,1,0,0],
				[1,0,0,1,1,1,0,0,0,0,0,0,1,1,0,0]
			],
			Bell2: [
				[0,0,1,1,0,1,1,0,0,0,0,1,1,0,0,0],
				[0,0,1,1,0,1,0,0,1,0,0,1,0,0,0,0],
				[1,1,1,1,0,0,1,0,1,0,0,1,0,0,0,0],
				[1,1,1,1,0,0,0,0,0,0,0,1,1,0,0,0],
				[1,0,1,0,1,1,1,0,1,0,0,1,0,0,0,0],
				[1,0,1,0,1,1,0,0,0,0,0,1,1,0,0,0],
				[0,1,1,0,1,0,1,0,0,0,0,1,1,0,0,0],
				[0,1,1,0,1,0,0,0,1,0,0,1,0,0,0,0],
				[0,1,0,1,1,1,1,0,1,0,0,1,0,0,0,0],
				[0,1,0,1,1,1,0,0,0,0,0,1,1,0,0,0]
			],
			Baby: [
				[1,0,1,1,1,1,1,0,1,0,1,0,0,0,0,0],
				[1,0,1,1,1,1,1,0,0,0,1,0,1,0,0,0],
				[0,1,1,1,1,0,1,0,0,0,1,0,1,0,0,0],	// Verified
				[0,1,1,1,1,0,1,0,1,0,1,0,0,0,0,0],
				[0,0,1,1,0,0,1,0,0,0,1,0,1,0,0,0],
				[0,0,1,1,0,0,1,0,1,0,1,0,0,0,0,0],
				[1,1,1,1,0,0,1,0,1,0,1,0,0,0,0,0],
				[1,1,1,1,0,0,1,0,0,0,1,0,1,0,0,0],
				[1,1,1,1,0,0,1,0,0,0,1,0,1,0,0,0],
				[1,1,1,1,0,0,1,0,1,0,1,0,0,0,0,0]
			],
			SilentCall: [
				[1,1,1,1,0,0,1,0,1,1,0,0,0,0,0,0],
				[1,1,1,1,0,0,1,0,0,1,0,0,1,0,0,0],
				[0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0],
				[0,0,1,1,0,0,1,0,1,1,0,0,0,0,0,0],
				[0,1,1,1,1,0,1,0,0,1,0,0,1,0,0,0],
				[0,1,1,1,1,0,1,0,1,1,0,0,0,0,0,0],
				[1,0,1,1,1,0,1,0,1,1,0,0,0,0,0,0],
				[1,0,1,1,1,0,1,0,0,1,0,0,1,0,0,0],
				[1,0,1,1,1,0,1,0,0,1,0,0,1,0,0,0],
				[1,0,1,1,1,0,1,0,1,1,0,0,0,0,0,0]
			],
			Fire: [
				[0,0,1,1,0,0,1,1,1,0,0,0,0,0,0,0],
				[0,0,1,1,0,0,1,1,0,0,0,0,1,0,0,0],
				[1,1,1,1,0,0,1,1,0,0,0,0,1,0,0,0],	// Verified
				[1,1,1,1,0,0,1,1,1,0,0,0,0,0,0,0],
				[1,0,1,1,1,0,1,1,0,0,0,0,1,0,0,0],
				[1,0,1,1,1,0,1,1,1,0,0,0,0,0,0,0],		
				[0,1,1,1,1,0,1,1,1,0,0,0,0,0,0,0],
				[0,1,1,1,1,0,1,1,0,0,0,0,1,0,0,0],
				[0,1,1,1,1,0,1,1,0,0,0,0,1,0,0,0],
				[0,1,1,1,1,0,1,1,1,0,0,0,0,0,0,0]
			]
		}
	}
};



function init()
{
	console.log("Init start");

	// Create and register signal
		var Signal = Homey.wireless('868').Signal;
		
		Signals.Lisa.SignalHandle = new Signal('signal_lisa');
		
		// Vreemd genoeg is dit ook nodig voor enkel versturen:
			Signals.Lisa.SignalHandle.register(
				function callback( err, result )
				{
					if( err ) return console.error( err );
					
					// on a receive event
					Signals.Lisa.SignalHandle.on('payload', function( payload ){
						console.log('received Lisa from a device:', payload)
					});
				}
			);
		//
	//
	
	Homey.manager('flow').on(
		'action.sendrf',
		function( callback, args)
		{
			if(args["what"])
			{
				var FrameType = args["what"];
				var Channel = parseInt(args["channel"], 10);
				
				if(
					(
						Signals.Lisa["Frames"][FrameType] !== undefined
					)&&(
						Signals.Lisa["Frames"][FrameType][Channel] !== undefined
					)
				){
					var Signal = Signals.Lisa.SignalHandle;
					var Frame = Signals.Lisa["Frames"][FrameType][Channel];
					
					Signal.tx(
						Frame,
						function(A, B)
						{
							console.log("Transmitted " + FrameType + "/" + Channel);
							
							// Let homey know the flow worked just fine
							callback( null, true);	
						}
					);
					return;
				}else{
					console.log("Sorry, unable to transmit " + FrameType + "/" + Channel);
				}
			}
			// Let Homey know something went wrong
			callback( null, false);
		}
	);
	
	console.log("Init done");
}

module.exports.init = init;